<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="2GET">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.json">
  <title>2Go Expense Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:       #0f172a;
      --bg-card:  #1e293b;
      --accent:   #f59e0b;
      --accent2:  #6366f1;
      --text:     #f8fafc;
      --text-2:   #94a3b8;
      --text-3:   #64748b;
      --border:   rgba(255,255,255,0.06);
      --danger:   #ef4444;
      --r:        16px;
      --r-sm:     10px;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
    }

    /* â”€â”€ Screen management â”€â”€ */
    .screen { display:none; min-height:100vh; min-height:-webkit-fill-available; }
    .screen.active { display:flex; flex-direction:column; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #login-screen {
      position: relative;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      overflow: hidden;
    }

    #login-screen::before {
      content: '';
      position: absolute;
      top: -200px; right: -150px;
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(245,158,11,0.12) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }

    #login-screen::after {
      content: '';
      position: absolute;
      bottom: -200px; left: -150px;
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }

    .login-container {
      width: 100%;
      max-width: 400px;
      animation: fadeInUp 0.6s ease both;
    }

    .login-logo { text-align:center; margin-bottom:36px; }

    .logo-icon {
      width: 72px; height: 72px;
      background: linear-gradient(135deg, var(--accent), #d97706);
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      box-shadow: 0 20px 60px rgba(245,158,11,0.3);
    }

    .logo-icon svg { width:36px; height:36px; fill:#0f172a; }

    .login-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .login-sub {
      font-size: 14px;
      color: var(--text-2);
      margin-top: 6px;
    }

    .login-card {
      background: var(--bg-card);
      border-radius: var(--r);
      padding: 32px 28px;
      border: 1px solid var(--border);
      box-shadow: 0 32px 64px rgba(0,0,0,0.4);
    }

    .form-group { margin-bottom: 20px; }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .input-wrap { position: relative; }

    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1.5px solid #334155;
      border-radius: var(--r-sm);
      padding: 14px 16px;
      font-size: 16px;
      font-family: 'DM Sans', sans-serif;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
    }

    .form-input::placeholder { color: var(--text-3); }

    .pw-toggle {
      position: absolute;
      right: 14px; top: 50%;
      transform: translateY(-50%);
      background: none; border: none;
      cursor: pointer;
      color: var(--text-3);
      display: flex; align-items: center;
      padding: 4px;
    }

    .pw-input { padding-right: 48px; }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), #d97706);
      color: #0f172a;
      border: none;
      border-radius: var(--r-sm);
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s, transform 0.1s;
      letter-spacing: 0.3px;
    }

    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

    .err-msg {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: var(--r-sm);
      padding: 12px 16px;
      font-size: 14px;
      color: #fca5a5;
      margin-top: 14px;
      display: none;
    }

    .err-msg.show { display: block; animation: fadeInUp 0.3s ease; }

    .admin-link {
      text-align: center;
      margin-top: 28px;
    }

    .admin-link button {
      background: none; border: none;
      font-size: 12px;
      color: var(--text-3);
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      padding: 6px 10px;
      border-radius: 6px;
      transition: color 0.2s;
    }

    .admin-link button:hover { color: var(--text-2); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HOME SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .top-bar {
      background: var(--bg-card);
      padding: 52px 24px 24px;
      border-bottom: 1px solid var(--border);
    }

    .top-bar-label {
      font-size: 12px;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 4px;
    }

    .top-bar-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      font-weight: 700;
    }

    .top-bar-sub {
      font-size: 13px;
      color: var(--text-3);
      margin-top: 4px;
    }

    .screen-body { padding: 28px 24px; flex: 1; overflow-y: auto; }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 16px;
    }

    .tracker-cards { display: flex; flex-direction: column; gap: 14px; }

    .tracker-card {
      background: var(--bg-card);
      border-radius: var(--r);
      padding: 22px 20px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .tracker-card:active { transform: scale(0.98); }
    .tracker-card.daily  { border-left: 4px solid var(--accent); }
    .tracker-card.holiday{ border-left: 4px solid var(--accent2); }

    .tc-icon {
      width: 50px; height: 50px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .tracker-card.daily   .tc-icon { background: rgba(245,158,11,0.15); }
    .tracker-card.holiday .tc-icon { background: rgba(99,102,241,0.15); }
    .tracker-card.daily   .tc-icon svg { fill: var(--accent); }
    .tracker-card.holiday .tc-icon svg { fill: #818cf8; }
    .tc-icon svg { width:24px; height:24px; }

    .tc-info { flex:1; }

    .tc-title { font-size:17px; font-weight:600; margin-bottom:3px; }
    .tc-desc  { font-size:13px; color:var(--text-2); line-height:1.4; }

    .tc-arrow { color: var(--text-3); flex-shrink:0; }

    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-ghost {
      flex: 1;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: var(--r-sm);
      padding: 13px 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-2);
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      transition: background 0.2s;
    }

    .btn-ghost:active { background: rgba(255,255,255,0.08); }
    .btn-ghost svg { width:15px; height:15px; fill:currentColor; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PLACEHOLDER SCREENS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .placeholder-screen {
      align-items: center;
      justify-content: center;
      padding: 48px 32px;
      text-align: center;
    }

    .badge {
      display: inline-block;
      background: rgba(245,158,11,0.15);
      color: var(--accent);
      font-size: 11px;
      font-weight: 600;
      padding: 5px 14px;
      border-radius: 100px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 20px;
    }

    .placeholder-screen h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .placeholder-screen p {
      font-size: 15px;
      color: var(--text-2);
      line-height: 1.65;
      max-width: 300px;
      margin: 0 auto;
    }

    .btn-back {
      margin-top: 32px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: var(--r-sm);
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-back:active { background: rgba(255,255,255,0.09); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXPENSE FORM & LIST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .expense-form {
      background: var(--bg-card);
      border-radius: var(--r);
      padding: 24px 20px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    select.form-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
      cursor: pointer;
    }

    .field-disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    .field-disabled select,
    .field-disabled input {
      cursor: not-allowed;
      background: rgba(255,255,255,0.02);
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 5px;
      font-style: italic;
    }

    code {
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    ol, ul {
      line-height: 1.7;
    }

    .expense-item {
      background: var(--bg-card);
      border-radius: var(--r-sm);
      padding: 16px 18px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      position: relative;
    }

    .expense-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .expense-item-detail {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 3px;
    }

    .expense-item-category {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 9px;
      border-radius: 6px;
      background: rgba(245,158,11,0.12);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .expense-item-amount {
      font-family: 'Cormorant Garamond', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      text-align: right;
    }

    .expense-item-currency {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-2);
      margin-left: 2px;
    }

    .expense-item-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-3);
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.04);
    }

    .expense-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .expense-meta-label {
      color: var(--text-3);
    }

    .expense-meta-value {
      color: var(--text-2);
      font-weight: 500;
    }

    .expense-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-edit, .btn-delete {
      flex: 1;
      padding: 9px 12px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      border: none;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-edit {
      background: rgba(255,255,255,0.05);
      color: var(--text-2);
      border: 1px solid rgba(255,255,255,0.07);
    }

    .btn-delete {
      background: rgba(239,68,68,0.1);
      color: #fca5a5;
      border: 1px solid rgba(239,68,68,0.2);
    }

    .btn-edit svg, .btn-delete svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-3);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 14px;
      line-height: 1.6;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ADMIN SCREEN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .admin-card {
      background: var(--bg-card);
      border-radius: var(--r);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .admin-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .admin-row:last-child { border-bottom: none; }

    .admin-row-title { font-size:15px; font-weight:500; }
    .admin-row-sub   { font-size:12px; color:var(--text-3); margin-top:2px; }

    .btn-sm {
      background: rgba(245,158,11,0.15);
      color: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 7px 13px;
      font-size:13px; font-weight:600;
      font-family:'DM Sans',sans-serif;
      cursor:pointer;
    }

    .btn-sm-danger {
      background: rgba(239,68,68,0.1);
      color: #fca5a5;
      border: none;
      border-radius: 8px;
      padding: 7px 13px;
      font-size:13px; font-weight:600;
      font-family:'DM Sans',sans-serif;
      cursor:pointer;
      margin-left:8px;
    }

    .admin-section { margin-bottom:28px; }

    .notice {
      background: rgba(245,158,11,0.1);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: var(--r-sm);
      padding: 13px 16px;
      margin-bottom: 22px;
      font-size: 14px;
      color: #fcd34d;
      line-height: 1.5;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODALS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: flex-end;
      z-index: 200;
    }

    .overlay.show { display:flex; animation: fadeIn 0.2s ease; }

    .modal {
      background: var(--bg-card);
      border-radius: 24px 24px 0 0;
      padding: 28px 24px 44px;
      width: 100%;
      animation: slideUp 0.28s ease;
    }

    .modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 22px;
    }

    .modal-hint {
      font-size: 14px;
      color: var(--text-2);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-btns { display:flex; gap:12px; margin-top:20px; }

    .btn-cancel {
      flex:1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: var(--r-sm);
      padding: 14px;
      font-size:15px; font-weight:500;
      color: var(--text-2);
      font-family:'DM Sans',sans-serif;
      cursor:pointer;
    }

    .btn-confirm {
      flex:1;
      background: linear-gradient(135deg, var(--accent), #d97706);
      border: none;
      border-radius: var(--r-sm);
      padding: 14px;
      font-size:15px; font-weight:600;
      color: #0f172a;
      font-family:'DM Sans',sans-serif;
      cursor:pointer;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px); }
      to   { opacity:1; transform:translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity:0; } to { opacity:1; }
    }

    @keyframes slideUp {
      from { transform:translateY(40px); }
      to   { transform:translateY(0); }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen" class="screen active">
  <div class="login-container">

    <div class="login-logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
      </div>
      <div class="login-title">2GoExpenseTracker</div>
      <div class="login-sub">Family Finance Manager</div>
    </div>

    <div class="login-card">
      <div class="form-group">
        <label class="form-label" for="login-user">Username</label>
        <input class="form-input" type="text" id="login-user"
               placeholder="Enter your username"
               autocapitalize="none" autocorrect="off" autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label" for="login-pw">Password</label>
        <div class="input-wrap">
          <input class="form-input pw-input" type="password" id="login-pw"
                 placeholder="Enter your password" autocomplete="current-password">
          <button class="pw-toggle" onclick="togglePw()" type="button" aria-label="Show/hide password">
            <svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
      </div>
      <button class="btn-primary" onclick="doLogin()">Sign In</button>
      <div class="err-msg" id="login-err">Incorrect username or password.</div>
    </div>

    <div class="admin-link">
      <button onclick="openAdminGate()">âš™ Admin Setup</button>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="home-screen" class="screen">
  <div class="top-bar">
    <div class="top-bar-label">Welcome back</div>
    <div class="top-bar-title" id="home-name">â€”</div>
    <div class="top-bar-sub"  id="home-date">â€”</div>
  </div>

  <div class="screen-body">
    <div class="section-label">Choose Tracker</div>

    <div class="tracker-cards">
      <div class="tracker-card daily" onclick="goTo('daily-screen')">
        <div class="tc-icon">
          <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5C3.89 3 3 3.9 3 5L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
        </div>
        <div class="tc-info">
          <div class="tc-title">Daily Tracker</div>
          <div class="tc-desc">Groceries, transport, utilities &amp; more</div>
        </div>
        <div class="tc-arrow">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>

      <div class="tracker-card holiday" onclick="goTo('holiday-screen')">
        <div class="tc-icon">
          <svg viewBox="0 0 24 24"><path d="M13.5 3.5c0 1.04-.82 1.88-1.85 1.98L12 5.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2zm-6.9 14.7l1-4.3L9 15v3h2v-4.97l-2.68-1.3.88-3.73C9.95 9 11.05 9.5 12 9.5c.95 0 2.07-.5 2.8-1.5l.88 3.73L13 13v5h2v-3l1.4-1.1 1 4.3 1.94-.52-1.4-5.97C17.56 11 17 9.68 16 9l-2.31-1.5c-.37-.24-.76-.37-1.13-.43L12 7c-.72 0-1.43.28-1.97.78L8.08 9c-1.03.68-1.59 2-1.94 3.2L4.74 18.2l1.86.5z"/></svg>
        </div>
        <div class="tc-info">
          <div class="tc-title">Holiday Tracker</div>
          <div class="tc-desc">Hotels, flights, attractions &amp; travel costs</div>
        </div>
        <div class="tc-arrow">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>
    </div>

    <div class="action-row">
      <button class="btn-ghost" onclick="goTo('export-screen')">
        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        Export / Sync
      </button>
      <button class="btn-ghost" onclick="doLogout()">
        <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        Sign Out
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” DAILY TRACKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="daily-screen" class="screen">
  <div class="top-bar">
    <div class="top-bar-label">Daily Expenses</div>
    <div class="top-bar-title">Daily Tracker</div>
    <div class="top-bar-sub">Record your daily spending</div>
  </div>

  <div class="screen-body">
    <!-- Add Expense Form -->
    <div class="section-label">New Expense</div>
    
    <div class="expense-form">
      <div class="form-group">
        <label class="form-label">Transaction Detail</label>
        <input class="form-input" type="text" id="daily-detail"
               placeholder="e.g. Grab to office, Groceries at AEON">
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label class="form-label">Category</label>
          <select class="form-input" id="daily-category" onchange="handleCategoryChange('daily')">
            <option value="">Select...</option>
            <option value="Transportation">Transportation</option>
            <option value="Grocery">Grocery</option>
            <option value="Food & Beverage">Food & Beverage</option>
            <option value="Shopping">Shopping</option>
            <option value="Utilities">Utilities</option>
            <option value="Healthcare">Healthcare</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">Currency</label>
          <select class="form-input" id="daily-currency">
            <option value="MYR">MYR</option>
            <option value="USD">USD</option>
            <option value="SGD">SGD</option>
            <option value="THB">THB</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="AUD">AUD</option>
            <option value="JPY">JPY</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Amount</label>
        <input class="form-input" type="number" id="daily-amount"
               placeholder="0.00" step="0.01" min="0">
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1" id="daily-debit-wrap">
          <label class="form-label">Received Into <span style="color:var(--text-3);font-weight:400">(optional)</span></label>
          <select class="form-input" id="daily-debit">
            <option value="">Select...</option>
          </select>
          <div class="field-hint" id="daily-debit-hint" style="display:none">Not applicable for this category</div>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">Paid From <span style="color:#fca5a5">*</span></label>
          <select class="form-input" id="daily-credit">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <button class="btn-primary" onclick="saveDailyExpense()">Add Expense</button>
      <div class="err-msg" id="err-daily">Please fill in all required fields.</div>
    </div>

    <!-- Expenses List -->
    <div class="section-label" style="margin-top:32px">Your Daily Expenses</div>
    <div id="daily-list"></div>

    <button class="btn-back" onclick="goTo('home-screen')">â† Back to Home</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” HOLIDAY TRACKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="holiday-screen" class="screen">
  <div class="top-bar">
    <div class="top-bar-label">Holiday Expenses</div>
    <div class="top-bar-title">Holiday Tracker</div>
    <div class="top-bar-sub">Record your travel spending</div>
  </div>

  <div class="screen-body">
    <!-- Add Expense Form -->
    <div class="section-label">New Holiday Expense</div>
    
    <div class="expense-form">
      <!-- Trip Name - Special field for holidays -->
      <div class="form-group">
        <label class="form-label">Trip Name</label>
        <div style="display:flex; gap:8px; align-items:flex-end;">
          <select class="form-input" id="holiday-trip" style="flex:1">
            <option value="">Select trip or add new...</option>
          </select>
          <button class="btn-sm" onclick="openAddTrip()" style="flex-shrink:0; padding:12px 16px;">+ New</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Transaction Detail</label>
        <input class="form-input" type="text" id="holiday-detail"
               placeholder="e.g. Hotel check-in, Flight to Bangkok">
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label class="form-label">Category</label>
          <select class="form-input" id="holiday-category" onchange="handleCategoryChange('holiday')">
            <option value="">Select...</option>
            <option value="Transportation">Transportation</option>
            <option value="Food & Beverage">Food & Beverage</option>
            <option value="Accommodation">Accommodation</option>
            <option value="Attraction">Attraction</option>
            <option value="Shopping">Shopping</option>
            <option value="Travel Insurance">Travel Insurance</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">Currency</label>
          <select class="form-input" id="holiday-currency">
            <option value="MYR">MYR</option>
            <option value="USD">USD</option>
            <option value="SGD">SGD</option>
            <option value="THB">THB</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="AUD">AUD</option>
            <option value="JPY">JPY</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Amount</label>
        <input class="form-input" type="number" id="holiday-amount"
               placeholder="0.00" step="0.01" min="0">
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1" id="holiday-debit-wrap">
          <label class="form-label">Received Into <span style="color:var(--text-3);font-weight:400">(optional)</span></label>
          <select class="form-input" id="holiday-debit">
            <option value="">Select...</option>
          </select>
          <div class="field-hint" id="holiday-debit-hint" style="display:none">Not applicable for this category</div>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">Paid From <span style="color:#fca5a5">*</span></label>
          <select class="form-input" id="holiday-credit">
            <option value="">Select...</option>
          </select>
        </div>
      </div>

      <button class="btn-primary" onclick="saveHolidayExpense()">Add Expense</button>
      <div class="err-msg" id="err-holiday">Please fill in all required fields.</div>
    </div>

    <!-- Filter by trip -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:32px; margin-bottom:16px;">
      <div class="section-label" style="margin:0">Your Holiday Expenses</div>
      <select class="form-input" id="filter-trip" onchange="loadHolidayExpenses()"
              style="width:auto; min-width:140px; padding:8px 12px; font-size:13px;">
        <option value="">All trips</option>
      </select>
    </div>

    <div id="holiday-list"></div>

    <button class="btn-back" onclick="goTo('home-screen')">â† Back to Home</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5 â€” EXPORT & SYNC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="export-screen" class="screen">
  <div class="top-bar">
    <div class="top-bar-label">Data Export</div>
    <div class="top-bar-title">Export & Sync</div>
    <div class="top-bar-sub">Download your data for Excel</div>
  </div>

  <div class="screen-body">
    <div class="notice" style="display:block; margin-bottom:24px;">
      ğŸ“Š Export your expenses as CSV files that open directly in Excel. Save to OneDrive for automatic sync to your desktop.
    </div>

    <!-- Daily Tracker Export -->
    <div class="admin-section">
      <div class="section-label">Daily Tracker</div>
      <div class="admin-card">
        <div class="admin-row">
          <div>
            <div class="admin-row-title">Daily Expenses CSV</div>
            <div class="admin-row-sub" id="daily-export-count">â€”</div>
          </div>
          <button class="btn-sm" onclick="exportDailyCSV()">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Holiday Tracker Export -->
    <div class="admin-section">
      <div class="section-label">Holiday Tracker</div>
      <div class="admin-card">
        <div class="admin-row">
          <div>
            <div class="admin-row-title">Holiday Expenses CSV</div>
            <div class="admin-row-sub" id="holiday-export-count">â€”</div>
          </div>
          <button class="btn-sm" onclick="exportHolidayCSV()">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="admin-section">
      <div class="section-label">How to Sync with OneDrive</div>
      <div style="background:var(--bg-card); border-radius:var(--r); padding:20px; border:1px solid var(--border); font-size:14px; line-height:1.7; color:var(--text-2);">
        <p style="margin:0 0 12px 0; font-weight:500; color:var(--text);">Setup (One-time only):</p>
        <ol style="margin:0; padding-left:20px;">
          <li style="margin-bottom:8px;">Install <strong style="color:var(--text)">OneDrive app</strong> on your iPhone (free from App Store)</li>
          <li style="margin-bottom:8px;">Sign in with your Microsoft account</li>
          <li style="margin-bottom:8px;">On your Windows PC, make sure OneDrive is running and signed in</li>
          <li>Create folder: <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px; color:var(--accent);">Documents\ExpenseTracker\</code></li>
        </ol>
        
        <p style="margin:16px 0 12px 0; font-weight:500; color:var(--text);">Daily sync workflow:</p>
        <ol style="margin:0; padding-left:20px;">
          <li style="margin-bottom:8px;">Tap <strong style="color:var(--text)">Export CSV</strong> button above</li>
          <li style="margin-bottom:8px;">When file downloads, tap <strong style="color:var(--text)">Share</strong> â†’ <strong style="color:var(--text)">Save to Files</strong></li>
          <li style="margin-bottom:8px;">Navigate to <strong style="color:var(--text)">OneDrive â†’ Documents â†’ ExpenseTracker</strong></li>
          <li>Tap <strong style="color:var(--text)">Save</strong> â€” file auto-syncs to your PC</li>
        </ol>

        <p style="margin:16px 0 0 0; padding:12px; background:rgba(245,158,11,0.1); border-radius:8px; border-left:3px solid var(--accent); font-size:13px;">
          ğŸ’¡ <strong style="color:var(--text)">Tip:</strong> Your Excel desktop app can auto-refresh data from the OneDrive folder. No manual import needed!
        </p>
      </div>
    </div>

    <button class="btn-back" onclick="goTo('home-screen')">â† Back to Home</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 6 â€” ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="admin-screen" class="screen">
  <div class="top-bar">
    <div class="top-bar-label">Administration</div>
    <div class="top-bar-title">Admin Setup</div>
    <div class="top-bar-sub">Manage users and accounts</div>
  </div>

  <div class="screen-body">
    <div id="admin-notice" class="notice" style="display:none">
      ğŸ‘‹ First time setup â€” please add at least one user to get started.
    </div>

    <!-- Users -->
    <div class="admin-section">
      <div class="section-label">Users</div>
      <div class="admin-card" id="users-list"></div>
      <button class="btn-ghost" style="width:100%; margin-top:12px" onclick="openAddUser()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Add User
      </button>
    </div>

    <!-- Accounts -->
    <div class="admin-section">
      <div class="section-label">Accounts (Debit &amp; Credit)</div>
      <div class="admin-card" id="accounts-list"></div>
      <button class="btn-ghost" style="width:100%; margin-top:12px" onclick="openAddAccount()">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        Add Account
      </button>
    </div>

    <button class="btn-back" onclick="goTo('login-screen')">â† Back to Login</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Admin gate (enter master password) -->
<div class="overlay" id="modal-admin-gate">
  <div class="modal">
    <div class="modal-title">Admin Access</div>
    <div class="form-group">
      <label class="form-label">Master Password</label>
      <input class="form-input" type="password" id="input-master" placeholder="Enter master password">
    </div>
    <div class="err-msg" id="err-admin-gate">Incorrect master password.</div>
    <div class="modal-btns">
      <button class="btn-cancel"  onclick="closeModal('modal-admin-gate')">Cancel</button>
      <button class="btn-confirm" onclick="verifyMaster()">Enter</button>
    </div>
  </div>
</div>

<!-- Set master password (first time) -->
<div class="overlay" id="modal-set-master">
  <div class="modal">
    <div class="modal-title">Create Master Password</div>
    <p class="modal-hint">This is your admin password. Store it safely â€” it controls all user accounts.</p>
    <div class="form-group">
      <label class="form-label">New Master Password</label>
      <input class="form-input" type="password" id="input-new-master" placeholder="Choose a strong password">
    </div>
    <div class="form-group">
      <label class="form-label">Confirm Password</label>
      <input class="form-input" type="password" id="input-confirm-master" placeholder="Repeat password">
    </div>
    <div class="err-msg" id="err-set-master">Passwords do not match.</div>
    <div class="modal-btns">
      <button class="btn-cancel"  onclick="closeModal('modal-set-master')">Cancel</button>
      <button class="btn-confirm" onclick="saveMaster()">Save</button>
    </div>
  </div>
</div>

<!-- Add user -->
<div class="overlay" id="modal-add-user">
  <div class="modal">
    <div class="modal-title">Add User</div>
    <div class="form-group">
      <label class="form-label">Full Name</label>
      <input class="form-input" type="text" id="input-uname" placeholder="e.g. Ahmad">
    </div>
    <div class="form-group">
      <label class="form-label">Username (for login)</label>
      <input class="form-input" type="text" id="input-ulogin"
             placeholder="e.g. ahmad" autocapitalize="none">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input class="form-input" type="password" id="input-upw" placeholder="Choose a password">
    </div>
    <div class="err-msg" id="err-add-user">Please fill in all fields.</div>
    <div class="modal-btns">
      <button class="btn-cancel"  onclick="closeModal('modal-add-user')">Cancel</button>
      <button class="btn-confirm" onclick="saveUser()">Add User</button>
    </div>
  </div>
</div>

<!-- Add account -->
<div class="overlay" id="modal-add-account">
  <div class="modal">
    <div class="modal-title">Add Account</div>
    <div class="form-group">
      <label class="form-label">Account Name</label>
      <input class="form-input" type="text" id="input-acct"
             placeholder="e.g. Maybank Savings">
    </div>
    <div class="err-msg" id="err-add-acct">Please enter an account name.</div>
    <div class="modal-btns">
      <button class="btn-cancel"  onclick="closeModal('modal-add-account')">Cancel</button>
      <button class="btn-confirm" onclick="saveAccount()">Add Account</button>
    </div>
  </div>
</div>

<!-- Add trip name -->
<div class="overlay" id="modal-add-trip">
  <div class="modal">
    <div class="modal-title">Add Trip</div>
    <p class="modal-hint">Create a name for this holiday or trip (e.g. "Bangkok May 2026", "Bali Family Trip")</p>
    <div class="form-group">
      <label class="form-label">Trip Name</label>
      <input class="form-input" type="text" id="input-trip"
             placeholder="e.g. Bangkok May 2026">
    </div>
    <div class="err-msg" id="err-add-trip">Please enter a trip name.</div>
    <div class="modal-btns">
      <button class="btn-cancel"  onclick="closeModal('modal-add-trip')">Cancel</button>
      <button class="btn-confirm" onclick="saveTrip()">Add Trip</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
};

// â”€â”€ Password hashing (SHA-256 via WebCrypto) â”€â”€â”€â”€â”€
async function hashPw(pw) {
  const buf = await crypto.subtle.digest(
    'SHA-256',
    new TextEncoder().encode(pw + 'ET_FAMILY_2026')
  );
  return Array.from(new Uint8Array(buf))
              .map(b => b.toString(16).padStart(2,'0'))
              .join('');
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTo(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePw() {
  const el = document.getElementById('login-pw');
  el.type = el.type === 'password' ? 'text' : 'password';
}

async function doLogin() {
  const username = document.getElementById('login-user').value.trim().toLowerCase();
  const password = document.getElementById('login-pw').value;
  const errEl    = document.getElementById('login-err');

  if (!username || !password) {
    errEl.textContent = 'Please enter your username and password.';
    errEl.classList.add('show');
    return;
  }

  const users  = S.get('et_users') || [];
  const hashed = await hashPw(password);
  const user   = users.find(u => u.username === username && u.hash === hashed);

  if (user) {
    errEl.classList.remove('show');
    document.getElementById('login-user').value = '';
    document.getElementById('login-pw').value   = '';
    S.set('et_session', user.username);

    // Populate home screen
    document.getElementById('home-name').textContent = user.name || user.username;
    document.getElementById('home-date').textContent =
      new Date().toLocaleDateString('en-MY',
        { weekday:'long', year:'numeric', month:'long', day:'numeric' });

    goTo('home-screen');
  } else {
    errEl.textContent = 'Incorrect username or password. Please try again.';
    errEl.classList.add('show');
  }
}

function doLogout() {
  S.set('et_session', null);
  goTo('login-screen');
}

// Allow Enter key on login form
document.getElementById('login-pw').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});
document.getElementById('login-user').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('login-pw').focus();
});

// â”€â”€ Admin gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdminGate() {
  if (!S.get('et_master')) {
    // First time â€” create master password
    document.getElementById('input-new-master').value    = '';
    document.getElementById('input-confirm-master').value = '';
    document.getElementById('err-set-master').classList.remove('show');
    document.getElementById('modal-set-master').classList.add('show');
  } else {
    document.getElementById('input-master').value = '';
    document.getElementById('err-admin-gate').classList.remove('show');
    document.getElementById('modal-admin-gate').classList.add('show');
  }
}

async function verifyMaster() {
  const input  = document.getElementById('input-master').value;
  const stored = S.get('et_master');
  const hashed = await hashPw(input);
  if (hashed === stored) {
    closeModal('modal-admin-gate');
    refreshAdmin();
    goTo('admin-screen');
  } else {
    document.getElementById('err-admin-gate').classList.add('show');
  }
}

async function saveMaster() {
  const pw1 = document.getElementById('input-new-master').value;
  const pw2 = document.getElementById('input-confirm-master').value;
  const err = document.getElementById('err-set-master');
  if (!pw1 || pw1.length < 4) {
    err.textContent = 'Password must be at least 4 characters.';
    err.classList.add('show'); return;
  }
  if (pw1 !== pw2) {
    err.textContent = 'Passwords do not match.';
    err.classList.add('show'); return;
  }
  S.set('et_master', await hashPw(pw1));
  err.classList.remove('show');
  closeModal('modal-set-master');
  refreshAdmin();
  goTo('admin-screen');
}

// â”€â”€ Admin screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAdmin() {
  const users    = S.get('et_users')    || [];
  const accounts = S.get('et_accounts') || [];

  document.getElementById('admin-notice').style.display =
    users.length === 0 ? 'block' : 'none';

  // Users list
  const uEl = document.getElementById('users-list');
  uEl.innerHTML = users.length === 0
    ? '<div class="admin-row"><div class="admin-row-sub" style="color:var(--text-3)">No users yet.</div></div>'
    : users.map((u,i) => `
        <div class="admin-row">
          <div>
            <div class="admin-row-title">${u.name}</div>
            <div class="admin-row-sub">@${u.username}</div>
          </div>
          <button class="btn-sm-danger" onclick="removeUser(${i})">Remove</button>
        </div>`).join('');

  // Accounts list
  const aEl = document.getElementById('accounts-list');
  aEl.innerHTML = accounts.length === 0
    ? '<div class="admin-row"><div class="admin-row-sub" style="color:var(--text-3)">No accounts yet.</div></div>'
    : accounts.map((a,i) => `
        <div class="admin-row">
          <div class="admin-row-title">${a}</div>
          <button class="btn-sm-danger" onclick="removeAccount(${i})">Remove</button>
        </div>`).join('');
}

// â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddUser() {
  ['input-uname','input-ulogin','input-upw'].forEach(id =>
    document.getElementById(id).value = '');
  document.getElementById('err-add-user').classList.remove('show');
  document.getElementById('modal-add-user').classList.add('show');
}

async function saveUser() {
  const name     = document.getElementById('input-uname').value.trim();
  const username = document.getElementById('input-ulogin').value.trim().toLowerCase();
  const pw       = document.getElementById('input-upw').value;
  const err      = document.getElementById('err-add-user');

  if (!name || !username || !pw) {
    err.textContent = 'Please fill in all fields.';
    err.classList.add('show'); return;
  }
  if (pw.length < 4) {
    err.textContent = 'Password must be at least 4 characters.';
    err.classList.add('show'); return;
  }

  const users = S.get('et_users') || [];
  if (users.find(u => u.username === username)) {
    err.textContent = 'That username is already taken. Choose another.';
    err.classList.add('show'); return;
  }

  users.push({ name, username, hash: await hashPw(pw) });
  S.set('et_users', users);
  closeModal('modal-add-user');
  refreshAdmin();
}

function removeUser(i) {
  const users = S.get('et_users') || [];
  users.splice(i,1);
  S.set('et_users', users);
  refreshAdmin();
}

// â”€â”€ Accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddAccount() {
  document.getElementById('input-acct').value = '';
  document.getElementById('err-add-acct').classList.remove('show');
  document.getElementById('modal-add-account').classList.add('show');
}

function saveAccount() {
  const name = document.getElementById('input-acct').value.trim();
  const err  = document.getElementById('err-add-acct');
  if (!name) { err.classList.add('show'); return; }
  const accounts = S.get('et_accounts') || [];
  accounts.push(name);
  S.set('et_accounts', accounts);
  closeModal('modal-add-account');
  refreshAdmin();
}

function removeAccount(i) {
  const accounts = S.get('et_accounts') || [];
  accounts.splice(i,1);
  S.set('et_accounts', accounts);
  refreshAdmin();
}

// â”€â”€ PWA service worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () =>
    navigator.serviceWorker.register('sw.js').catch(() => {}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORY-BASED FIELD DEACTIVATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Categories where money only goes OUT â€” Received Into is not applicable
const OUTGOING_CATEGORIES = [
  'Transportation', 'Grocery', 'Food & Beverage', 'Shopping',
  'Utilities', 'Healthcare', 'Entertainment',
  'Accommodation', 'Attraction', 'Travel Insurance'
];

function handleCategoryChange(tracker) {
  const categoryEl  = document.getElementById(`${tracker}-category`);
  const debitWrap   = document.getElementById(`${tracker}-debit-wrap`);
  const debitEl     = document.getElementById(`${tracker}-debit`);
  const debitHint   = document.getElementById(`${tracker}-debit-hint`);
  const selected    = categoryEl.value;

  if (selected && OUTGOING_CATEGORIES.includes(selected)) {
    // Deactivate Received Into
    debitWrap.classList.add('field-disabled');
    debitEl.value    = '';        // Clear any previous selection
    debitEl.disabled = true;
    debitHint.style.display = 'block';
  } else {
    // Activate Received Into
    debitWrap.classList.remove('field-disabled');
    debitEl.disabled = false;
    debitHint.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY TRACKER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Populate account dropdowns
function populateDailyAccounts() {
  const accounts = S.get('et_accounts') || [];
  const debitEl  = document.getElementById('daily-debit');
  const creditEl = document.getElementById('daily-credit');
  
  const options = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
  debitEl.innerHTML  = '<option value="">Select...</option>' + options;
  creditEl.innerHTML = '<option value="">Select...</option>' + options;
}

// Load daily expenses when screen opens
function loadDailyExpenses() {
  populateDailyAccounts();
  
  const session = S.get('et_session');
  if (!session) return;
  
  const expenses = S.get(`et_daily_${session}`) || [];
  const listEl   = document.getElementById('daily-list');
  
  if (expenses.length === 0) {
    listEl.innerHTML = `
      <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <div class="empty-state-text">No expenses recorded yet.<br>Add your first expense above!</div>
      </div>`;
    return;
  }
  
  // Sort by date descending (newest first)
  expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
  
  listEl.innerHTML = expenses.map((exp, idx) => {
    const date = new Date(exp.date);
    const dateStr = date.toLocaleDateString('en-MY', { 
      day: 'numeric', month: 'short', year: 'numeric' 
    });
    
    return `
      <div class="expense-item">
        <div class="expense-item-header">
          <div>
            <div class="expense-item-detail">${exp.detail}</div>
            <span class="expense-item-category">${exp.category}</span>
          </div>
          <div class="expense-item-amount">
            ${parseFloat(exp.amount).toFixed(2)}
            <span class="expense-item-currency">${exp.currency}</span>
          </div>
        </div>
        <div class="expense-item-meta">
          <div class="expense-meta-item">
            <span class="expense-meta-label">Date:</span>
            <span class="expense-meta-value">${dateStr}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">No:</span>
            <span class="expense-meta-value">${exp.no}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">Paid From:</span>
            <span class="expense-meta-value">${exp.credit || 'â€”'}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">Received Into:</span>
            <span class="expense-meta-value">${exp.debit || 'â€”'}</span>
          </div>
        </div>
        <div class="expense-actions">
          <button class="btn-edit" onclick="editDailyExpense('${exp.id}')">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            Edit
          </button>
          <button class="btn-delete" onclick="deleteDailyExpense('${exp.id}')">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Delete
          </button>
        </div>
      </div>`;
  }).join('');
}

// Save new daily expense
function saveDailyExpense() {
  const detail   = document.getElementById('daily-detail').value.trim();
  const category = document.getElementById('daily-category').value;
  const currency = document.getElementById('daily-currency').value;
  const amount   = document.getElementById('daily-amount').value;
  const debit    = document.getElementById('daily-debit').value;
  const credit   = document.getElementById('daily-credit').value;
  const errEl    = document.getElementById('err-daily');
  
  // Validation
  if (!detail || !category || !amount) {
    errEl.textContent = 'Please fill in Transaction Detail, Category, and Amount.';
    errEl.classList.add('show');
    return;
  }
  
  if (!credit) {
    errEl.textContent = 'Please select a "Paid From" account.';
    errEl.classList.add('show');
    return;
  }
  
  // Check if same account on both sides - must check BEFORE disabled state matters
  if (debit && debit.trim() !== '' && credit && credit.trim() !== '' && debit.trim() === credit.trim()) {
    errEl.textContent = 'Received Into and Paid From cannot be the same account.';
    errEl.classList.add('show');
    return;
  }
  
  if (parseFloat(amount) <= 0) {
    errEl.textContent = 'Amount must be greater than zero.';
    errEl.classList.add('show');
    return;
  }
  
  errEl.classList.remove('show');
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_daily_${session}`) || [];
  
  const now   = new Date();
  const month = now.toLocaleDateString('en-MY', { month: 'short', year: 'numeric' });
  
  const newExpense = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    no: expenses.length + 1,
    date: now.toISOString(),
    month: month,
    detail: detail,
    category: category,
    currency: currency,
    amount: parseFloat(amount).toFixed(2),
    debit: debit,
    credit: credit
  };
  
  expenses.push(newExpense);
  S.set(`et_daily_${session}`, expenses);
  
  // Clear form
  document.getElementById('daily-detail').value   = '';
  document.getElementById('daily-category').value = '';
  document.getElementById('daily-amount').value   = '';
  document.getElementById('daily-debit').value    = '';
  document.getElementById('daily-credit').value   = '';
  
  // Reload list
  loadDailyExpenses();
  
  // Scroll to top to see new expense
  document.getElementById('daily-screen').scrollTop = 0;
}

// Edit expense
let editingDailyId = null;

function editDailyExpense(id) {
  const session  = S.get('et_session');
  const expenses = S.get(`et_daily_${session}`) || [];
  const exp      = expenses.find(e => e.id === id);
  
  if (!exp) return;
  
  // Populate form with expense data
  document.getElementById('daily-detail').value   = exp.detail;
  document.getElementById('daily-category').value = exp.category;
  document.getElementById('daily-currency').value = exp.currency;
  document.getElementById('daily-amount').value   = exp.amount;
  document.getElementById('daily-debit').value    = exp.debit || '';
  document.getElementById('daily-credit').value   = exp.credit || '';
  
  // Trigger category change to set correct field state
  handleCategoryChange('daily');
  
  // Track which expense is being edited
  editingDailyId = id;
  
  // Change button text
  const btn = document.querySelector('#daily-screen .btn-primary');
  btn.textContent = 'Update Expense';
  btn.onclick = updateDailyExpense;
  
  // Scroll to top
  document.getElementById('daily-screen').scrollTop = 0;
}

function updateDailyExpense() {
  const detail   = document.getElementById('daily-detail').value.trim();
  const category = document.getElementById('daily-category').value;
  const currency = document.getElementById('daily-currency').value;
  const amount   = document.getElementById('daily-amount').value;
  const debit    = document.getElementById('daily-debit').value;
  const credit   = document.getElementById('daily-credit').value;
  const errEl    = document.getElementById('err-daily');
  
  if (!detail || !category || !amount) {
    errEl.textContent = 'Please fill in Transaction Detail, Category, and Amount.';
    errEl.classList.add('show');
    return;
  }
  
  if (!credit) {
    errEl.textContent = 'Please select a "Paid From" account.';
    errEl.classList.add('show');
    return;
  }
  
  // Check if same account on both sides
  if (debit && debit.trim() !== '' && credit && credit.trim() !== '' && debit.trim() === credit.trim()) {
    errEl.textContent = 'Received Into and Paid From cannot be the same account.';
    errEl.classList.add('show');
    return;
  }
  
  if (parseFloat(amount) <= 0) {
    errEl.textContent = 'Amount must be greater than zero.';
    errEl.classList.add('show');
    return;
  }
  
  errEl.classList.remove('show');
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_daily_${session}`) || [];
  
  if (editingDailyId) {
    const expIndex = expenses.findIndex(e => e.id === editingDailyId);
    if (expIndex !== -1) {
      // Keep original date, number, and ID
      expenses[expIndex].detail   = detail;
      expenses[expIndex].category = category;
      expenses[expIndex].currency = currency;
      expenses[expIndex].amount   = parseFloat(amount).toFixed(2);
      expenses[expIndex].debit    = debit;
      expenses[expIndex].credit   = credit;
      
      S.set(`et_daily_${session}`, expenses);
    }
  }
  
  // Reset form
  cancelDailyEdit();
  loadDailyExpenses();
}

function cancelDailyEdit() {
  editingDailyId = null;
  
  document.getElementById('daily-detail').value   = '';
  document.getElementById('daily-category').value = '';
  document.getElementById('daily-amount').value   = '';
  document.getElementById('daily-debit').value    = '';
  document.getElementById('daily-credit').value   = '';
  
  // Reset Received Into field state
  handleCategoryChange('daily');
  
  const btn = document.querySelector('#daily-screen .btn-primary');
  btn.textContent = 'Add Expense';
  btn.onclick = saveDailyExpense;
}

// Delete expense
function deleteDailyExpense(id) {
  if (!confirm('Delete this expense? This cannot be undone.')) return;
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_daily_${session}`) || [];
  
  const expIndex = expenses.findIndex(e => e.id === id);
  if (expIndex !== -1) {
    expenses.splice(expIndex, 1);
    
    // Renumber remaining expenses
    expenses.forEach((exp, i) => exp.no = i + 1);
    
    S.set(`et_daily_${session}`, expenses);
    loadDailyExpenses();
  }
}

// Load expenses when navigating to daily screen
const originalGoTo = goTo;
goTo = function(id) {
  originalGoTo(id);
  if (id === 'daily-screen') {
    cancelDailyEdit();
    loadDailyExpenses();
  }
  if (id === 'holiday-screen') {
    cancelHolidayEdit();
    loadHolidayExpenses();
  }
  if (id === 'export-screen') {
    loadExportCounts();
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT & CSV FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Update export counts when screen loads
function loadExportCounts() {
  const session = S.get('et_session');
  if (!session) return;
  
  const dailyExpenses   = S.get(`et_daily_${session}`) || [];
  const holidayExpenses = S.get(`et_holiday_${session}`) || [];
  
  document.getElementById('daily-export-count').textContent = 
    `${dailyExpenses.length} expense${dailyExpenses.length !== 1 ? 's' : ''} ready to export`;
  
  document.getElementById('holiday-export-count').textContent = 
    `${holidayExpenses.length} expense${holidayExpenses.length !== 1 ? 's' : ''} ready to export`;
}

// Helper: Escape CSV field (handle commas, quotes, newlines)
function escapeCSV(field) {
  if (field == null) return '';
  const str = String(field);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

// Helper: Format date for Excel
function formatDateForExcel(isoDate) {
  const date = new Date(isoDate);
  const day   = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year  = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// Helper: Trigger file download
function downloadCSV(filename, csvContent) {
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url  = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.display = 'none';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
}

// Export Daily Tracker CSV
function exportDailyCSV() {
  const session  = S.get('et_session');
  const expenses = S.get(`et_daily_${session}`) || [];
  
  if (expenses.length === 0) {
    alert('No daily expenses to export.');
    return;
  }
  
  // CSV Header - Category removed, Received Into and Paid From reordered
  const headers = [
    'No', 'Date', 'Entry Month', 'Transaction Detail', 
    'Currency', 'Amount', 'Received Into', 'Paid From'
  ];
  
  let csv = headers.join(',') + '\n';
  
  // CSV Rows
  expenses.forEach(exp => {
    // Auto-fill Received Into with category name, unless category is "Others"
    let receivedInto;
    if (exp.category === 'Others') {
      // For Others, use user's manual selection (or blank)
      receivedInto = exp.debit || '';
    } else {
      // For all other categories, use category name as the debit account
      receivedInto = exp.category;
    }
    
    const row = [
      exp.no,
      formatDateForExcel(exp.date),
      escapeCSV(exp.month),
      escapeCSV(exp.detail),
      exp.currency,
      exp.amount,
      escapeCSV(receivedInto),
      escapeCSV(exp.credit || '')
    ];
    csv += row.join(',') + '\n';
  });
  
  // Generate filename with username and date
  const username = S.get('et_session');
  const today    = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const filename = `${username}_daily_${today}.csv`;
  
  downloadCSV(filename, csv);
}

// Export Holiday Tracker CSV
function exportHolidayCSV() {
  const session  = S.get('et_session');
  const expenses = S.get(`et_holiday_${session}`) || [];
  
  if (expenses.length === 0) {
    alert('No holiday expenses to export.');
    return;
  }
  
  // CSV Header - Category removed, Received Into auto-filled
  const headers = [
    'Trip Name', 'No', 'Date', 'Entry Month', 'Transaction Detail', 
    'Currency', 'Amount', 'Received Into', 'Paid From'
  ];
  
  let csv = headers.join(',') + '\n';
  
  // CSV Rows
  expenses.forEach(exp => {
    // Auto-fill Received Into with category name, unless category is "Others"
    let receivedInto;
    if (exp.category === 'Others') {
      // For Others, use user's manual selection (or blank)
      receivedInto = exp.debit || '';
    } else {
      // For all other categories, use category name as the debit account
      receivedInto = exp.category;
    }
    
    const row = [
      escapeCSV(exp.trip),
      exp.no,
      formatDateForExcel(exp.date),
      escapeCSV(exp.month),
      escapeCSV(exp.detail),
      exp.currency,
      exp.amount,
      escapeCSV(receivedInto),
      escapeCSV(exp.credit || '')
    ];
    csv += row.join(',') + '\n';
  });
  
  // Generate filename
  const username = S.get('et_session');
  const today    = new Date().toISOString().split('T')[0];
  const filename = `${username}_holiday_${today}.csv`;
  
  downloadCSV(filename, csv);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOLIDAY TRACKER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Populate account dropdowns for holiday
function populateHolidayAccounts() {
  const accounts = S.get('et_accounts') || [];
  const debitEl  = document.getElementById('holiday-debit');
  const creditEl = document.getElementById('holiday-credit');
  
  const options = accounts.map(a => `<option value="${a}">${a}</option>`).join('');
  debitEl.innerHTML  = '<option value="">Select...</option>' + options;
  creditEl.innerHTML = '<option value="">Select...</option>' + options;
}

// Populate trip dropdown
function populateTrips() {
  const session = S.get('et_session');
  const trips   = S.get(`et_trips_${session}`) || [];
  const tripEl  = document.getElementById('holiday-trip');
  const filterEl = document.getElementById('filter-trip');
  
  const options = trips.map(t => `<option value="${t}">${t}</option>`).join('');
  tripEl.innerHTML = '<option value="">Select trip or add new...</option>' + options;
  
  const currentFilter = filterEl.value;
  filterEl.innerHTML = '<option value="">All trips</option>' + options;
  filterEl.value = currentFilter; // Preserve filter selection
}

// Open add trip modal
function openAddTrip() {
  document.getElementById('input-trip').value = '';
  document.getElementById('err-add-trip').classList.remove('show');
  document.getElementById('modal-add-trip').classList.add('show');
}

// Save new trip
function saveTrip() {
  const name = document.getElementById('input-trip').value.trim();
  const err  = document.getElementById('err-add-trip');
  
  if (!name) { 
    err.textContent = 'Please enter a trip name.';
    err.classList.add('show'); 
    return; 
  }
  
  const session = S.get('et_session');
  const trips   = S.get(`et_trips_${session}`) || [];
  
  if (trips.includes(name)) {
    err.textContent = 'This trip name already exists.';
    err.classList.add('show');
    return;
  }
  
  trips.push(name);
  S.set(`et_trips_${session}`, trips);
  
  closeModal('modal-add-trip');
  populateTrips();
  
  // Auto-select the newly added trip
  document.getElementById('holiday-trip').value = name;
}

// Load holiday expenses
function loadHolidayExpenses() {
  populateHolidayAccounts();
  populateTrips();
  
  const session = S.get('et_session');
  if (!session) return;
  
  let expenses = S.get(`et_holiday_${session}`) || [];
  const listEl = document.getElementById('holiday-list');
  
  // Filter by trip if selected
  const filterTrip = document.getElementById('filter-trip').value;
  if (filterTrip) {
    expenses = expenses.filter(e => e.trip === filterTrip);
  }
  
  if (expenses.length === 0) {
    const msg = filterTrip 
      ? `No expenses for "${filterTrip}" yet.`
      : 'No holiday expenses recorded yet.<br>Add your first expense above!';
    
    listEl.innerHTML = `
      <div class="empty-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
          <path d="M12 12h.01"/>
          <path d="M8 12h.01"/>
          <path d="M16 12h.01"/>
        </svg>
        <div class="empty-state-text">${msg}</div>
      </div>`;
    return;
  }
  
  // Sort by date descending
  expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
  
  listEl.innerHTML = expenses.map((exp, idx) => {
    const date = new Date(exp.date);
    const dateStr = date.toLocaleDateString('en-MY', { 
      day: 'numeric', month: 'short', year: 'numeric' 
    });
    
    return `
      <div class="expense-item">
        <div class="expense-item-header">
          <div>
            <div class="expense-item-detail">${exp.detail}</div>
            <span class="expense-item-category">${exp.category}</span>
          </div>
          <div class="expense-item-amount">
            ${parseFloat(exp.amount).toFixed(2)}
            <span class="expense-item-currency">${exp.currency}</span>
          </div>
        </div>
        <div class="expense-item-meta">
          <div class="expense-meta-item">
            <span class="expense-meta-label">Trip:</span>
            <span class="expense-meta-value">${exp.trip}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">Date:</span>
            <span class="expense-meta-value">${dateStr}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">No:</span>
            <span class="expense-meta-value">${exp.no}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">Paid From:</span>
            <span class="expense-meta-value">${exp.credit || 'â€”'}</span>
          </div>
          <div class="expense-meta-item">
            <span class="expense-meta-label">Received Into:</span>
            <span class="expense-meta-value">${exp.debit || 'â€”'}</span>
          </div>
        </div>
        <div class="expense-actions">
          <button class="btn-edit" onclick="editHolidayExpense('${exp.id}')">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            Edit
          </button>
          <button class="btn-delete" onclick="deleteHolidayExpense('${exp.id}')">
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Delete
          </button>
        </div>
      </div>`;
  }).join('');
}

// Save new holiday expense
function saveHolidayExpense() {
  const trip     = document.getElementById('holiday-trip').value;
  const detail   = document.getElementById('holiday-detail').value.trim();
  const category = document.getElementById('holiday-category').value;
  const currency = document.getElementById('holiday-currency').value;
  const amount   = document.getElementById('holiday-amount').value;
  const debit    = document.getElementById('holiday-debit').value;
  const credit   = document.getElementById('holiday-credit').value;
  const errEl    = document.getElementById('err-holiday');
  
  // Validation
  if (!trip) {
    errEl.textContent = 'Please select or create a trip name.';
    errEl.classList.add('show');
    return;
  }
  
  if (!detail || !category || !amount) {
    errEl.textContent = 'Please fill in Transaction Detail, Category, and Amount.';
    errEl.classList.add('show');
    return;
  }
  
  if (!credit) {
    errEl.textContent = 'Please select a "Paid From" account.';
    errEl.classList.add('show');
    return;
  }
  
  // Check if same account on both sides
  if (debit && debit.trim() !== '' && credit && credit.trim() !== '' && debit.trim() === credit.trim()) {
    errEl.textContent = 'Received Into and Paid From cannot be the same account.';
    errEl.classList.add('show');
    return;
  }
  
  if (parseFloat(amount) <= 0) {
    errEl.textContent = 'Amount must be greater than zero.';
    errEl.classList.add('show');
    return;
  }
  
  errEl.classList.remove('show');
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_holiday_${session}`) || [];
  
  const now   = new Date();
  const month = now.toLocaleDateString('en-MY', { month: 'short', year: 'numeric' });
  
  const newExpense = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    no: expenses.length + 1,
    trip: trip,
    date: now.toISOString(),
    month: month,
    detail: detail,
    category: category,
    currency: currency,
    amount: parseFloat(amount).toFixed(2),
    debit: debit,
    credit: credit
  };
  
  expenses.push(newExpense);
  S.set(`et_holiday_${session}`, expenses);
  
  // Clear form
  document.getElementById('holiday-trip').value     = '';
  document.getElementById('holiday-detail').value   = '';
  document.getElementById('holiday-category').value = '';
  document.getElementById('holiday-amount').value   = '';
  document.getElementById('holiday-debit').value    = '';
  document.getElementById('holiday-credit').value   = '';
  
  // Reload list
  loadHolidayExpenses();
  
  // Scroll to top
  document.getElementById('holiday-screen').scrollTop = 0;
}

// Edit holiday expense
let editingHolidayId = null;

function editHolidayExpense(id) {
  const session  = S.get('et_session');
  const expenses = S.get(`et_holiday_${session}`) || [];
  const exp      = expenses.find(e => e.id === id);
  
  if (!exp) return;
  
  // Populate form
  document.getElementById('holiday-trip').value     = exp.trip;
  document.getElementById('holiday-detail').value   = exp.detail;
  document.getElementById('holiday-category').value = exp.category;
  document.getElementById('holiday-currency').value = exp.currency;
  document.getElementById('holiday-amount').value   = exp.amount;
  document.getElementById('holiday-debit').value    = exp.debit || '';
  document.getElementById('holiday-credit').value   = exp.credit || '';
  
  // Trigger category change to set correct field state
  handleCategoryChange('holiday');
  
  editingHolidayId = id;
  
  // Change button
  const btn = document.querySelector('#holiday-screen .btn-primary');
  btn.textContent = 'Update Expense';
  btn.onclick = updateHolidayExpense;
  
  // Scroll to top
  document.getElementById('holiday-screen').scrollTop = 0;
}

function updateHolidayExpense() {
  const trip     = document.getElementById('holiday-trip').value;
  const detail   = document.getElementById('holiday-detail').value.trim();
  const category = document.getElementById('holiday-category').value;
  const currency = document.getElementById('holiday-currency').value;
  const amount   = document.getElementById('holiday-amount').value;
  const debit    = document.getElementById('holiday-debit').value;
  const credit   = document.getElementById('holiday-credit').value;
  const errEl    = document.getElementById('err-holiday');
  
  if (!trip || !detail || !category || !amount) {
    errEl.textContent = 'Please fill in all required fields.';
    errEl.classList.add('show');
    return;
  }
  
  if (!credit) {
    errEl.textContent = 'Please select a "Paid From" account.';
    errEl.classList.add('show');
    return;
  }
  
  // Check if same account on both sides
  if (debit && debit.trim() !== '' && credit && credit.trim() !== '' && debit.trim() === credit.trim()) {
    errEl.textContent = 'Received Into and Paid From cannot be the same account.';
    errEl.classList.add('show');
    return;
  }
  
  if (parseFloat(amount) <= 0) {
    errEl.textContent = 'Amount must be greater than zero.';
    errEl.classList.add('show');
    return;
  }
  
  errEl.classList.remove('show');
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_holiday_${session}`) || [];
  
  if (editingHolidayId) {
    const expIndex = expenses.findIndex(e => e.id === editingHolidayId);
    if (expIndex !== -1) {
      expenses[expIndex].trip     = trip;
      expenses[expIndex].detail   = detail;
      expenses[expIndex].category = category;
      expenses[expIndex].currency = currency;
      expenses[expIndex].amount   = parseFloat(amount).toFixed(2);
      expenses[expIndex].debit    = debit;
      expenses[expIndex].credit   = credit;
      
      S.set(`et_holiday_${session}`, expenses);
    }
  }
  
  cancelHolidayEdit();
  loadHolidayExpenses();
}

function cancelHolidayEdit() {
  editingHolidayId = null;
  
  document.getElementById('holiday-trip').value     = '';
  document.getElementById('holiday-detail').value   = '';
  document.getElementById('holiday-category').value = '';
  document.getElementById('holiday-amount').value   = '';
  document.getElementById('holiday-debit').value    = '';
  document.getElementById('holiday-credit').value   = '';
  
  // Reset Received Into field state
  handleCategoryChange('holiday');
  
  const btn = document.querySelector('#holiday-screen .btn-primary');
  btn.textContent = 'Add Expense';
  btn.onclick = saveHolidayExpense;
}

// Delete holiday expense
function deleteHolidayExpense(id) {
  if (!confirm('Delete this expense? This cannot be undone.')) return;
  
  const session  = S.get('et_session');
  const expenses = S.get(`et_holiday_${session}`) || [];
  
  const expIndex = expenses.findIndex(e => e.id === id);
  if (expIndex !== -1) {
    expenses.splice(expIndex, 1);
    
    // Renumber
    expenses.forEach((exp, i) => exp.no = i + 1);
    
    S.set(`et_holiday_${session}`, expenses);
    loadHolidayExpenses();
  }
}


</script>
</body>
</html>
